bundle:
  name: classify_tickets_system

variables:
  catalog:
    description: Unity Catalog name
    default: classify_tickets_new_dev
  
  schema:
    description: Schema name
    default: support_ai
  
  deployment_mode:
    description: "Deployment mode: full (clean slate) or incremental (update only changes)"
    default: incremental
  
  vector_endpoint:
    description: "Shared Vector Search endpoint name (NEVER DELETED - shared across projects)"
    default: one-env-shared-endpoint-2
  
  genie_space_id:
    description: "Genie Space ID for historical ticket queries"
    default: 01f0b91aa91c1b0c8cce6529ea09f0a8

workspace:
  host: https://adb-984752964297111.11.azuredatabricks.net

targets:
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/dev

resources:
  # Databricks jobs for setup and data preparation
  jobs:
    setup_infrastructure:
      name: "[dev] Setup Infrastructure"
      
      # NO job_clusters section - dev uses existing cluster only!
      
      tasks:
        # ═══════════════════════════════════════════════════════
        # CLEANUP (only runs in FULL mode)
        # ═══════════════════════════════════════════════════════
        - task_key: cleanup_full_mode
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/00_cleanup_full_mode.py
            base_parameters:
              catalog: ${var.catalog}
              mode: ${var.deployment_mode}
              vector_endpoint: ${var.vector_endpoint}
              app_name: classify-tickets-dashboard-dev
            source: WORKSPACE
        
        # ═══════════════════════════════════════════════════════
        # SETUP INFRASTRUCTURE
        # ═══════════════════════════════════════════════════════
        - task_key: create_catalog_schema
          depends_on:
            - task_key: cleanup_full_mode
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/00_setup_catalog_schema.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: deploy_ai_classify
          depends_on:
            - task_key: create_catalog_schema
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/01_deploy_uc_function_ai_classify.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: deploy_ai_extract
          depends_on:
            - task_key: deploy_ai_classify
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/02_deploy_uc_function_ai_extract.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: deploy_ai_gen
          depends_on:
            - task_key: deploy_ai_extract
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/03_deploy_uc_function_ai_gen.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: deploy_quick_classify
          depends_on:
            - task_key: deploy_ai_gen
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/04_deploy_uc_function_quick_classify.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: upload_knowledge_docs
          depends_on:
            - task_key: deploy_quick_classify
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/10_upload_knowledge_docs.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: reload_kb_with_chunking
          depends_on:
            - task_key: upload_knowledge_docs
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/13_reload_kb_with_proper_chunking.py
            base_parameters:
              catalog: ${var.catalog}
              mode: ${var.deployment_mode}
            source: WORKSPACE
        
        - task_key: prepare_sample_tickets
          depends_on:
            - task_key: reload_kb_with_chunking
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/06_prepare_sample_tickets.py
            base_parameters:
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: create_vector_search_index
          depends_on:
            - task_key: prepare_sample_tickets
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/14_recreate_vector_search_index.py
            base_parameters:
              catalog: ${var.catalog}
              mode: ${var.deployment_mode}
              vector_endpoint: ${var.vector_endpoint}
            source: WORKSPACE
        
        - task_key: grant_app_permissions
          depends_on:
            - task_key: create_vector_search_index
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/08_grant_app_permissions.py
            base_parameters:
              app_name: classify-tickets-dashboard-dev
              catalog: ${var.catalog}
            source: WORKSPACE
        
        - task_key: grant_genie_permissions
          depends_on:
            - task_key: grant_app_permissions
          existing_cluster_id: 0304-162117-qgsi1x04
          notebook_task:
            notebook_path: ./notebooks/09_grant_genie_permissions.py
            base_parameters:
              app_name: classify-tickets-dashboard-dev
              genie_space_id: ${var.genie_space_id}
            source: WORKSPACE

  # Streamlit dashboard deployment
  apps:
    ticket_classification_dashboard:
      name: classify-tickets-dashboard-dev
      description: "AI-Powered Support Ticket Classification Dashboard (dev)"
      source_code_path: ./dashboard

